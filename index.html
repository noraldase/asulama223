<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$LUCKY Token Sale</title>
    <style>
        /* Base Styling & Variables (Pixel Theme) */
        :root {
            --color-amber-400: #fbbf24;
            --color-yellow-500: #eab308;
            --color-amber-600: #d97706;
            --color-green-500: #22c55e;
            --color-emerald-600: #059669;
            --color-red-500: #ef4444;
            --color-blue-500: #3b82f6;
            --color-white: #ffffff;
            --color-gray-900: #111827;
            --color-gray-800: #1f2937;
            --color-gray-700: #374151;
            --color-gray-600: #4b5563;
            --color-gray-500: #6b7280; 
            --color-gray-200: #E5E7EB; 
        }

        body {
            font-family: 'Courier New', monospace; 
            margin: 0;
            padding: 0;
            background-color: var(--color-yellow-500); 
            background-image: linear-gradient(to bottom right, var(--color-amber-400), var(--color-yellow-500), var(--color-amber-600));
            color: var(--color-gray-900);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Pixel Text & Border */
        .pixel-text {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .pixel-border {
            border: 4px solid #000;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.3), -2px -2px 0 rgba(255,255,255,0.1);
        }
        .pixel-box {
            border: 2px solid rgba(0,0,0,0.1);
        }

        /* Layout (Simple Tailwind-like classes) */
        .max-w-7xl { max-width: 1280px; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
        .relative { position: relative; }
        .z-10 { z-index: 10; }
        .min-h-screen { min-height: 100vh; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-3 { gap: 0.75rem; }
        .gap-12 { gap: 3rem; }
        .grid { display: grid; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        .space-y-8 > * + * { margin-top: 2rem; }
        .mt-20 { margin-top: 5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-white { color: var(--color-white); }
        .text-gray-900 { color: var(--color-gray-900); }
        .text-gray-700 { color: var(--color-gray-700); }
        .text-gray-600 { color: var(--color-gray-600); }
        .text-amber-500 { color: var(--color-yellow-500); }
        .text-amber-600 { color: var(--color-amber-600); }
        .text-green-600 { color: var(--color-emerald-600); }
        .text-sm { font-size: 0.875rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .text-5xl { font-size: 3rem; }
        .md\:text-base { font-size: 1rem; }
        .md\:text-5xl { font-size: 3rem; }
        .font-black { font-weight: 900; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .duration-1000 { transition-duration: 1000ms; }
        .ease-out { transition-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        .transform { transform: translate(0, 0) rotate(0) skewX(0) skewY(0) scaleX(1) scaleY(1); }
        .hover\:scale-105:hover { transform: scale(1.05); }
        .active\:scale-95:active { transform: scale(0.95); }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .rounded-lg { border-radius: 0.5rem; }
        .overflow-hidden { overflow: hidden; }

        /* Pixel Pattern Overlay */
        .pixel-pattern {
            position: absolute;
            inset: 0;
            opacity: 0.1;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.03) 2px, rgba(0,0,0,.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,.03) 2px, rgba(0,0,0,.03) 4px);
        }

        /* Header Specific */
        header { padding: 1.5rem; position: relative; z-index: 10; }
        .logo-box { width: 3rem; height: 3rem; background-color: var(--color-green-500); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; }
        .logo-icon { width: 2rem; height: 2rem; color: var(--color-white); }

        /* Pixel Card */
        .pixel-card { background-color: var(--color-white); padding: 2rem; }
        @media (min-width: 768px) { .pixel-card { padding: 3rem; } }

        /* Pixel Button */
        .pixel-button {
            padding-left: 2rem; padding-right: 2rem; padding-top: 1rem; padding-bottom: 1rem;
            font-weight: 900; font-size: 1.125rem; 
            transition: all 0.2s;
            position: relative;
            cursor: pointer;
            border: 4px solid #000; 
            box-shadow: 8px 8px 0 rgba(0,0,0,0.3), -2px -2px 0 rgba(255,255,255,0.1);
        }
        .pixel-button.primary { background-color: var(--color-yellow-500); color: var(--color-gray-900); }
        .pixel-button.primary:hover { background-color: var(--color-amber-400); transform: scale(1.05); }
        .pixel-button.secondary { background-color: var(--color-gray-900); color: var(--color-yellow-500); }
        .pixel-button.secondary:hover { background-color: var(--color-gray-800); transform: scale(1.05); }
        .pixel-button:active { transform: scale(0.95); }
        .pixel-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .inline-block { display: inline-block; vertical-align: middle; }
        .mr-2 { margin-right: 0.5rem; }

        /* Progress Circle */
        .progress-circle-container { position: relative; }
        .progress-circle-svg { transform: rotate(-90deg); }
        .progress-circle-text { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Loading State */
        .loading-state {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background-image: linear-gradient(to bottom right, var(--color-amber-400), var(--color-yellow-500), var(--color-amber-600));
        }
        
    </style>
</head>
<body>

    <div id="loading-indicator" class="loading-state">
        <div class="pixel-text text-4xl text-white animate-pulse">Loading...</div>
    </div>

    <div id="main-content" style="display: none;">
        <div class="pixel-pattern"></div>

        <header class="relative z-10">
            <div class="max-w-7xl mx-auto flex justify-between items-center px-6">
                <div class="flex items-center gap-3">
                    <div class="logo-box pixel-border">
                        <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2.5-4.5H11v-3h2v3h1.5v-5H11v-3H9.5v3h-2v5zm4.5-9.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5z"/></svg>
                    </div>
                    <div class="pixel-text text-2xl md:text-3xl font-black text-gray-900" id="header-title">
                        $LUCKY SALE
                    </div>
                </div>
                <button id="connect-wallet-btn" class="pixel-button primary text-sm md:text-base">
                    <svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 8a6 6 0 11-12 0 6 6 0 0112 0zm-6 4a4 4 0 100-8 4 4 0 000 8zm-6-4a6 6 0 006 6 6 6 0 100-12 6 6 0 00-6 6z" clip-rule="evenodd" /><path d="M2 10a8 8 0 1116 0 8 8 0 01-16 0z" /></svg>
                    <span id="connect-wallet-text">Connect Wallet</span>
                </button>
            </div>
        </header>

        <main class="relative z-10 max-w-7xl mx-auto px-6 py-12 md:py-20">
            <div class="grid grid-cols-1 gap-12 lg:gap-20 items-center"> <div class="flex justify-center">
                    <div class="relative">
                        <div class="w-64 h-64 md:w-80 md:h-80 bg-gray-900 pixel-border relative overflow-hidden group hover:scale-105 transition-transform duration-300">
                            <div class="absolute inset-0 bg-gradient-to-br from-green-500 to-emerald-600 opacity-20"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <svg class="w-32 h-32 text-amber-500 animate-pulse" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 11-2 0V6H3a1 1 0 110-2h1V3a1 1 0 011-1zm1 14a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0v-1H6a1 1 0 110-2h1v-1a1 1 0 011-1zm6-11a1 1 0 010-2h1V3a1 1 0 112 0v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0V6h-1zm3 11a1 1 0 11-2 0v-1h-1a1 1 0 110-2h1v-1a1 1 0 112 0v1h1a1 1 0 110 2h-1v1z" clip-rule="evenodd" /></svg>
                            </div>
                            <div class="absolute bottom-4 left-0 right-0 text-center">
                                <div class="pixel-text text-white text-xl font-black">MINT NOW!</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="pixel-card space-y-8">
                        <div class="text-center">
                            <div class="pixel-text text-3xl md:text-5xl font-black text-gray-900 mb-2">
                                MINT
                            </div>
                            <div class="pixel-text text-4xl md:text-6xl font-black text-amber-600" id="token-symbol-display">
                                $LUCKY
                            </div>
                        </div>

                        <div class="flex justify-center">
                            <div class="progress-circle-container" style="width: 280px; height: 280px;">
                                <svg width="280" height="280" class="progress-circle-svg">
                                    <circle cx="140" cy="140" r="130" fill="none" stroke="var(--color-gray-200)" stroke-width="20" />
                                    <circle id="progress-circle-fg" cx="140" cy="140" r="130" fill="none" stroke="var(--color-yellow-500)" stroke-width="20" stroke-dasharray="816.8" stroke-dashoffset="816.8" stroke-linecap="round" class="transition-all duration-1000 ease-out" />
                                </svg>
                                <div class="progress-circle-text">
                                    <div class="text-gray-500 text-sm md:text-base font-bold mb-1 pixel-text" id="remaining-text">REMAINING</div>
                                    <div class="text-2xl md:text-4xl font-black pixel-text">
                                        <span class="text-amber-500" id="progress-minted">0</span>
                                        <span class="text-gray-800" id="progress-total">/ 1</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="text-center pixel-text text-sm md:text-base text-gray-700" id="mint-rate-text">
                                Mint rate: Every $10 = 50,000 $LUCKY
                            </div>
                            
                            <button id="mint-button" class="pixel-button primary w-full flex items-center justify-center gap-2">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2.5-4.5H11v-3h2v3h1.5v-5H11v-3H9.5v3h-2v5zm4.5-9.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5z"/></svg>
                                MINT NOW
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="pixel-card text-center">
                            <div class="pixel-text text-gray-600 text-xs md:text-sm mb-2">MINTED</div>
                            <div class="pixel-text text-xl md:text-2xl font-black text-gray-900" id="stat-minted">
                                0
                            </div>
                            <div class="pixel-text text-xs text-amber-600" id="stat-percentage">0%</div>
                        </div>
                        
                        <div class="pixel-card text-center">
                            <div class="pixel-text text-gray-600 text-xs md:text-sm mb-2">REMAINING</div>
                            <div class="pixel-text text-xl md:text-2xl font-black text-gray-900" id="stat-remaining">
                                0
                            </div>
                            <div class="pixel-text text-xs text-green-600">Available</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="status-and-error" style="text-align: center; margin-top: 30px;">
                <div id="gas-display" style="color: var(--color-white);"></div> 
                <div id="status-message" style="color: #39ff14; font-weight: bold; margin-top: 10px;"></div>
                <div id="error-message" style="color: var(--color-danger); font-weight: bold; margin-top: 5px;"></div>
            </div>

        </main>

        <footer class="relative z-10 text-center py-8 mt-20">
            <div class="pixel-text text-gray-900 text-sm" id="footer-text">
                © 2025 Lucky Token Sale • All rights reserved
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // --- KONFIGURASI WEB3 ---
        const CHAIN_ID = 8453; // Base Mainnet
        const SALE_CONTRACT_ADDRESS = "0x...GANTI_ALAMAT_KONTRAK_SALE_TOKEN..."; // Ganti ini!
        const TOKEN_SYMBOL = "LUCKY";
        const TOKEN_RATE = 5000; // 5000 $LUCKY per 10 USDC
        const PRICE_PER_UNIT_USD = 10; // Harga per unit minting (10 USDC)

        // Variabel UI dan Web3
        const loadingIndicator = document.getElementById('loading-indicator');
        const mainContent = document.getElementById('main-content');
        const headerTitle = document.getElementById('header-title');
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const connectWalletText = document.getElementById('connect-wallet-text');
        const tokenSymbolDisplay = document.getElementById('token-symbol-display');
        const progressCircleFg = document.getElementById('progress-circle-fg');
        const progressMinted = document.getElementById('progress-minted');
        const progressTotal = document.getElementById('progress-total');
        const remainingText = document.getElementById('remaining-text');
        const mintRateText = document.getElementById('mint-rate-text');
        const mintButton = document.getElementById('mint-button');
        const statMinted = document.getElementById('stat-minted');
        const statPercentage = document.getElementById('stat-percentage');
        const statRemaining = document.getElementById('stat-remaining');
        const footerText = document.getElementById('footer-text');
        const gasDisplay = document.getElementById('gas-display');
        const statusMessage = document.getElementById('status-message');
        const errorMessage = document.getElementById('error-message');

        let provider;
        let signer;
        let userAddress;
        let saleContract;
        let tokenContract; // Anda mungkin perlu ini untuk total supply
        let tokenDecimals = 18; // Asumsi standar ERC20
        let totalTokenSupply = 1000000000; // 1 Miliar
        let mintedAmount = 0; // Akan diambil dari kontrak

        // ABI Minimal (Wajib ada fungsi ini di kontrak Sale Anda)
        const saleABI = [
            "function totalMinted() view returns (uint256)",
            "function totalTokenSupply() view returns (uint256)", // Fungsi untuk total supply
            "function mintTokens(uint256 amountToBuy)" // Fungsi untuk minting
        ];

        // --- FUNGSI UTAMA ---

        async function connectWallet() {
            errorMessage.textContent = '';
            statusMessage.textContent = 'Connecting...';

            if (typeof window.ethereum === 'undefined') {
                errorMessage.textContent = 'MetaMask or EVM wallet not detected.';
                return;
            }

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                const { chainId } = await provider.getNetwork();
                if (chainId !== CHAIN_ID) {
                    errorMessage.textContent = `Please switch to Base Mainnet (ID ${CHAIN_ID}).`;
                    signer = null; // Putuskan signer
                    return;
                }

                // Inisialisasi kontrak
                saleContract = new ethers.Contract(SALE_CONTRACT_ADDRESS, saleABI, signer);
                
                // Update UI sukses
                connectWalletText.textContent = `Connected: ${userAddress.substring(0, 4)}...${userAddress.substring(38)}`;
                connectWalletBtn.classList.remove('primary');
                connectWalletBtn.classList.add('secondary');
                connectWalletBtn.disabled = true; // Disable setelah terhubung
                statusMessage.textContent = '✅ Wallet Connected to Base.';
                
                // Aktifkan tombol mint
                mintButton.disabled = false; 

                // Ambil data gas
                fetchGasPrice();
                // Ambil data minting
                fetchMintData(); 
                
            } catch (error) {
                console.error("Wallet connection failed:", error);
                errorMessage.textContent = `Connection failed: ${error.message}`;
            }
        }

        async function fetchGasPrice() {
             if (!provider) return;
             try {
                const feeData = await provider.getFeeData();
                const gasPriceInGwei = feeData.gasPrice.div(1000000000); 
                gasDisplay.textContent = `⚡ Gas Price: ${gasPriceInGwei.toString()} Gwei (User Pays)`;
             } catch {
                gasDisplay.textContent = 'Could not fetch gas price.';
             }
        }
        
        async function fetchMintData() {
            if (!provider) return; // Butuh provider, tidak perlu signer
             statusMessage.textContent = 'Fetching mint status...';
            try {
                 const readOnlySaleContract = new ethers.Contract(SALE_CONTRACT_ADDRESS, saleABI, provider);
                 
                 // Ambil total supply dan minted dari kontrak
                 const fetchedTotalSupply = await readOnlySaleContract.totalTokenSupply();
                 const fetchedMinted = await readOnlySaleContract.totalMinted();
                 
                 // Konversi BigNumber ke number untuk kalkulasi (hati-hati jika angka terlalu besar)
                 totalTokenSupply = fetchedTotalSupply.toNumber(); // Asumsi tidak melebihi batas JS
                 mintedAmount = fetchedMinted.toNumber(); 
                 
                 updateUI(); // Update tampilan dengan data baru
                 statusMessage.textContent = 'Mint status updated.';

            } catch (error) {
                 console.error("Failed to fetch mint data:", error);
                 errorMessage.textContent = 'Failed to load sale data. Check contract address or network.';
            }
        }


        function updateUI() {
            const remaining = totalTokenSupply - mintedAmount;
            const percentageMinted = (mintedAmount / totalTokenSupply * 100);
            
            // Header
            headerTitle.textContent = `$${TOKEN_SYMBOL} SALE`;
            
            // Mint Card
            tokenSymbolDisplay.textContent = `$${TOKEN_SYMBOL}`;
            mintRateText.textContent = `Mint rate: Every $${PRICE_PER_UNIT_USD} = ${TOKEN_RATE.toLocaleString()} $${TOKEN_SYMBOL}`;
            
            // Progress Circle
            progressMinted.textContent = mintedAmount.toLocaleString();
            progressTotal.textContent = `/ ${totalTokenSupply.toLocaleString()}`;
            remainingText.textContent = 'REMAINING'; 
            
            const size = 280;
            const strokeWidth = 20;
            const radius = (size - strokeWidth) / 2;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentageMinted / 100) * circumference;
            progressCircleFg.style.strokeDashoffset = offset;

            // Stats
            statMinted.textContent = mintedAmount.toLocaleString();
            statPercentage.textContent = `${percentageMinted.toFixed(1)}%`;
            statRemaining.textContent = remaining.toLocaleString();

            // Footer
            footerText.textContent = `© 2025 ${TOKEN_SYMBOL} Sale • All rights reserved`;

            // Check if sold out
            if (mintedAmount >= totalTokenSupply) {
                mintButton.textContent = 'SOLD OUT!';
                mintButton.disabled = true;
                mintButton.classList.remove('primary');
                mintButton.classList.add('secondary');
            } else {
                 mintButton.disabled = !signer; // Aktif jika wallet terhubung
            }
        }

        // --- MINT FUNCTION (USER PAYS GAS) ---
        async function handleMint() {
            if (!signer) return alert('Please connect your wallet first!');
            
            statusMessage.textContent = 'Preparing transaction...';
            errorMessage.textContent = '';
            mintButton.disabled = true;
            
            try {
                 // Anda perlu mengimplementasikan logika untuk mendapatkan jumlah USDC
                 // atau jumlah token yang ingin dibeli, lalu mengkonversinya ke
                 // parameter yang dibutuhkan oleh fungsi mintTokens(uint256 amountToBuy) Anda.
                 // Contoh: Kita asumsikan `amountToBuy` adalah jumlah token yang ingin dibeli
                 // dan 1 unit pembelian = 10 USDC = 50,000 Token
                 const amountToBuy = TOKEN_RATE; // Beli 1 unit (50,000 token)

                 // Anda perlu menambahkan logika untuk mengirim pembayaran USDC
                 // Ini biasanya melibatkan:
                 // 1. Approve USDC ke Kontrak Sale
                 // 2. Memanggil fungsi mintTokens di Kontrak Sale
                 
                 // === CONTOH SIMULASI (Perlu diganti dengan logic USDC Approval & Call) ===
                 statusMessage.textContent = 'Waiting for wallet confirmation...';
                 // const tx = await saleContract.mintTokens(amountToBuy); // Panggil fungsi mint
                 // statusMessage.textContent = `Transaction sent: ${tx.hash.substring(0,10)}... Waiting for confirmation...`;
                 // await tx.wait();
                 // === AKHIR SIMULASI ===
                 
                 // Simulasikan sukses
                 await new Promise(resolve => setTimeout(resolve, 2000)); // Tunggu 2 detik
                 mintedAmount += amountToBuy; // Update state lokal
                 
                 alert(`Mint Successful! You received ${amountToBuy.toLocaleString()} $${TOKEN_SYMBOL}.`);
                 statusMessage.textContent = `✅ Mint Successful! Refreshing status...`;
                 
                 // Ambil data baru setelah mint
                 await fetchMintData(); 

            } catch (error) {
                 console.error("Minting failed:", error);
                 errorMessage.textContent = `Mint Failed: ${error.message || "User rejected or transaction failed."}`;
            } finally {
                 // Aktifkan kembali tombol jika belum sold out
                 updateUI(); 
            }
        }


        // --- Initial Load ---
        window.onload = () => {
            loadingIndicator.style.display = 'none';
            mainContent.style.display = 'block';
            connectWalletBtn.addEventListener('click', connectWallet);
            mintButton.addEventListener('click', handleMint);
            // Ambil data awal saat halaman dimuat (tanpa signer)
            fetchMintData(); 
        };

    </script>
</body>
</html>
