<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Required</title>
    <style>
        /* Gaya dasar */
        body { font-family: monospace, Courier New; margin: 40px; color: #333; }
        .container { max-width: 800px; margin: auto; padding: 0; }
        h1 { color: #ff9900; font-size: 2.5em; padding-bottom: 5px; margin-bottom: 15px; border-bottom: 2px solid #ff9900; }
        h2 { color: #555; font-size: 1.5em; margin-top: 25px; }
        .mint-options { display: flex; gap: 20px; margin-top: 15px; }

        /* Gaya Tombol */
        #connectWalletBtn { 
            padding: 12px 25px; 
            font-size: 18px; 
            border: none; 
            cursor: pointer; 
            border-radius: 8px; 
            background-color: #ff9900; 
            color: white; 
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .mint-btn { 
            padding: 10px 20px; 
            font-size: 16px; 
            border: 2px solid #007bff;
            background-color: #007bff; 
            color: white; 
            cursor: pointer; 
            border-radius: 5px; 
            transition: opacity 0.3s; 
            font-family: monospace;
        }
        .mint-btn:disabled { 
            background-color: #ccc; 
            border-color: #ccc;
            cursor: not-allowed; 
        }

        /* Gaya Pesan */
        #errorMessage { color: red; font-weight: bold; }
        #statusMessage { color: green; font-weight: bold; }
        #gasDisplay { margin-top: 10px; font-size: 0.9em; color: #555; }
        .warning { margin-top: 20px; padding: 10px; border: 1px solid #ffcc00; background-color: #fff9e6; border-radius: 5px; font-size: 0.9em;}
    </style>
</head>
<body>
    <div class="container">
        <h1>SHIUAX402 | $SHIUA Mint</h1>

        <h2>Mint Token</h2>
        <p>Token Rate: 1 USDC = 5,000 $SHIUA</p>
        <p>Supply: 1,000,000,000 $SHIBA (Total)</p>

        <button id="connectWalletBtn">Connect Wallet</button>

        <div id="mintOptions" class="mint-options" style="display: none;">
            <button id="mint1USDCBtn" class="mint-btn" data-usdc-amount="1" disabled>
                Mint 5,000 $SHIBA (1 USDC)
            </button>
            <button id="mint10USDCBtn" class="mint-btn" data-usdc-amount="10" disabled>
                Mint 50,000 $SHIBA (10 USDC)
            </button>
        </div>

        <div id="gasDisplay"></div>
        <div id="statusMessage" style="margin-top: 15px;"></div>
        <div id="errorMessage" style="margin-top: 5px;"></div>

        <hr style="margin-top: 30px; margin-bottom: 30px; border: 0; border-top: 1px solid #eee;">

        <h2>Social</h2>
        <p>Follow <a href="https://x.com/ShiuaX402" target="_blank" rel="noopener noreferrer">@ShiuaX402</a> on X</p>

        <div class="warning">
            ✅ Mint is live !!!
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // --- KONFIGURASI PROYEK SHIBA_X402 ---
        // GANTI SEMUA NILAI INI DENGAN DATA KONTRAK DAN RELAYER AKTUAL ANDA
        const RELAYER_URL = "https://api.us-ai.fun/shiba-mint"; // Ganti jika relayer endpoint berbeda
        const CONTRACT_SALE_MANAGER_ADDRESS = "0xED143D7C6195fD65C5b0a66F8d2B329E44ffE3D1"; // Tetap sama seperti referensi
        
        const USDC_CONTRACT_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"; // USDC Base Mainnet
        const CHAIN_ID = 8453; // Base Mainnet
        
        const BASE_RATE = 5000; // 1 USDC = 5000 $SHIBA
        
        // Harga USDC dalam WEI/smallest unit (1 USDC = 1,000,000)
        const ONE_USDC_TX = ethers.BigNumber.from('1000000'); 
        
        // --- DOM Elements ---
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const mintOptionsDiv = document.getElementById('mintOptions');
        const mint1USDCBtn = document.getElementById('mint1USDCBtn');
        const mint10USDCBtn = document.getElementById('mint10USDCBtn');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        const gasDisplay = document.getElementById('gasDisplay');

        // --- Variabel State Global ---
        let signer;
        let provider;
        let userAddress;
        let ownerWalletAddress; 

        const saleManagerABI = [
            "function wallet() view returns (address)", // ABI untuk mengambil alamat owner/penerima
        ];

        // --- WALLET CONNECTION (Fungsi tidak berubah) ---
        async function connectWallet() {
            errorMessage.textContent = '';
            statusMessage.textContent = 'Connecting...';
            gasDisplay.textContent = 'Fetching gas price...';

            if (typeof window.ethereum === 'undefined') {
                errorMessage.textContent = "Metamask not detected."; return;
            }
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                const { chainId } = await provider.getNetwork();
                if (chainId !== CHAIN_ID) {
                    errorMessage.textContent = `Please switch to the Base Mainnet.`; return;
                }

                // Deteksi Harga Gas
                try {
                    const feeData = await provider.getFeeData();
                    const gasPriceInGwei = feeData.gasPrice.div(1000000000);
                    gasDisplay.textContent = `⚡ Current Network Gas: ${gasPriceInGwei.toString()} Gwei`;
                } catch (gasError) {
                    gasDisplay.textContent = 'Could not fetch gas price.';
                }

                // Ambil alamat wallet owner
                statusMessage.textContent = 'Fetching sale configuration...';
                const saleContract = new ethers.Contract(CONTRACT_SALE_MANAGER_ADDRESS, saleManagerABI, provider);
                ownerWalletAddress = await saleContract.wallet();

                if (!ownerWalletAddress) {
                    errorMessage.textContent = 'Failed to read owner wallet address from contract.'; return;
                }

                connectWalletBtn.style.display = 'none';
                mintOptionsDiv.style.display = 'flex'; // Tampilkan dua tombol mint
                
                // Aktifkan kedua tombol mint
                mint1USDCBtn.disabled = false;
                mint10USDCBtn.disabled = false;
                
                statusMessage.textContent = `Wallet Connected: ${userAddress.substring(0, 6)}...`;
            } catch (error) {
                console.error("Connection Error:", error);
                errorMessage.textContent = `Connection aborted or failed.`;
            }
        }

        // --- MINT FUNCTION (GASLESS) - Fleksibel dengan Jumlah USDC ---
        async function mintToken(usdcAmount) {
            errorMessage.textContent = '';
            statusMessage.textContent = '1. Requesting Permit Signature';
            
            // Nonaktifkan semua tombol mint selama transaksi
            mint1USDCBtn.disabled = true;
            mint10USDCBtn.disabled = true;
            
            if (!ownerWalletAddress) {
                errorMessage.textContent = "Owner wallet not loaded. Please reconnect.";
                mint1USDCBtn.disabled = false;
                mint10USDCBtn.disabled = false;
                return;
            }

            // Hitung nilai USDC yang akan ditransfer (BigNumber)
            const usdcValueToTransfer = ONE_USDC_TX.mul(usdcAmount);
            const tokenAmount = usdcAmount * BASE_RATE;

            let response;
            try {
                // --- 1. Buat Tanda Tangan ---
                const currentTimestamp = Math.floor(Date.now() / 1000);
                const validBefore = currentTimestamp + (60 * 15);
                const validAfter = 0;
                // Nonce harus unik per transaksi
                const nonce = ethers.utils.solidityKeccak256(["uint256", "uint256"], [userAddress, Date.now()]); 

                const domain = { name: 'USD Coin', version: '2', chainId: CHAIN_ID, verifyingContract: USDC_CONTRACT_ADDRESS };
                const types = { TransferWithAuthorization: [ { name: 'from', type: 'address' }, { name: 'to', type: 'address' }, { name: 'value', type: 'uint256' }, { name: 'validAfter', type: 'uint256' }, { name: 'validBefore', type: 'uint256' }, { name: 'nonce', type: 'bytes32' }, ] };
                const message = { from: userAddress, to: ownerWalletAddress, value: usdcValueToTransfer, validAfter: validAfter, validBefore: validBefore, nonce: nonce };

                const signature = await signer._signTypedData(domain, types, message);
                const signatureParts = ethers.utils.splitSignature(signature);

                statusMessage.textContent = `2. Signature obtained for ${usdcAmount} USDC. Sending to server... (Gasless)`;

                // --- 2. KIRIM KE RELAYER ---
                const signatureBody = {
                    buyerAddress: userAddress,
                    validAfter: message.validAfter,
                    validBefore: message.validBefore,
                    nonce: message.nonce,
                    v: signatureParts.v,
                    r: signatureParts.r,
                    s: signatureParts.s,
                    usdcAmount: usdcAmount // Tambahkan amount agar relayer tahu berapa $SHIBA yang harus dikirim
                };

                response = await fetch(RELAYER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(signatureBody) 
                });
                
                // --- 3. PROSES RESPONS DENGAN HATI-HATI ---
                if (!response.ok) {
                    let errorMsg = `Server error (Status ${response.status})`;
                    try {
                        const errorBody = await response.json();
                        errorMsg = errorBody.error || errorMsg;
                    } catch (e) {
                        errorMsg = await response.text();
                    }
                    throw new Error(errorMsg);
                }

                // Jika status OK (200), coba parse JSON
                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    console.error("Gagal parse JSON respons:", parseError);
                    statusMessage.innerHTML = `✅ **Mint Likely Successful!** Sent ${usdcAmount} USDC. Check your wallet and Basescan.`;
                    return; 
                }
                
                // --- 4. TAMPILKAN HASIL SUKSES (JIKA JSON VALID) ---
                if (result.success && result.txHash) {
                    statusMessage.innerHTML = `✅ **Mint Success!** ${tokenAmount.toLocaleString()} $SHIBA sent! <br>Tx: <a href="https://basescan.org/tx/${result.txHash}" target="_blank">${result.txHash.substring(0,10)}...</a>`;
                } else {
                    errorMessage.textContent = `Mint Failed: ${result.error || "Server reported failure."}`;
                }

            } catch (error) { // Menangkap SEMUA error
                console.error("Minting process error:", error); 
                if (error.code === 4001) {
                    errorMessage.textContent = 'Transaction signature denied by the user.';
                } else {
                    errorMessage.textContent = `Mint Operation Failed: ${error.message || "Unknown error occurred."}`;
                }
            } finally {
                // Aktifkan kembali tombol
                mint1USDCBtn.disabled = false;
                mint10USDCBtn.disabled = false;
            }
        }
        
        // --- Event Listeners ---
        connectWalletBtn.addEventListener('click', connectWallet);
        
        // Listener untuk tombol 1 USDC
        mint1USDCBtn.addEventListener('click', () => {
            const amount = parseInt(mint1USDCBtn.getAttribute('data-usdc-amount'));
            mintToken(amount);
        });

        // Listener untuk tombol 10 USDC
        mint10USDCBtn.addEventListener('click', () => {
            const amount = parseInt(mint10USDCBtn.getAttribute('data-usdc-amount'));
            mintToken(amount);
        });
    </script>
</body>
</html>
